@{
    ViewData["Title"] = "Home Page";
}

@model IList<User>
<div class="card">
    <div class="progress" style="height: 2px;">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="card-header">
        <div class="float-left">
            <select class="custom-select my-1 mr-sm-2" id="emailddl">
                <option selected>Choose...</option>
                @foreach (var usr in Model)
                {
                    <option value="@usr.Id">@usr.Name ( @usr.Email )</option>
                }
            </select>
        </div>
        <div class="float-right">
            <button type="button" class="btn-submit btn btn-outline-primary btn-sm" onclick="sendEmail()">
                Send Email OTP
                <span class="spn-rotp badge badge-warning d-none">4</span>
            </button>
        </div>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <form action="Home/UserLogin" method="post" enctype="application/x-www-form-urlencoded">
                    <div class="form-group">
                        <label for="otp">Enter OTP sent to you email</label>
                        <input type="number" class="form-control" id="otp" name="otp" aria-describedby="otpHelp">
                        <small id="otpHelp" class="form-text text-muted">
                            Once your OTP is entered you will reach your pocket manager
                        </small>
                    </div>
                    <input type="hidden" name="userId"  id="userId"/>
                    <button type="submit" class="btn btn-primary float-md-right" >Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        $(document).ready(() => {
            $('.progress').hide();
        })

        let startTimerCount = 30
        let userId = 0;

        const showProgressDiv = () => {
            $('.progress').show();
        }
        const hideProgressDiv = () => {
            $('.progress').hide();
            progressStart(0)
        }

        function progressStart(e) {
            $('.progress .progress-bar').css("width", e + '%');
        }

        function sendEmail() {
            showProgressDiv()

            progressStart(20)
            progressStart(50)

            const email = $("#emailddl").val();
            progressStart(70);

            $.post("/Home/send-otp?usrId=" + email).done((res) => {
                progressStart(100)
                console.log(res);
                setTimeout(() => {
                    hideProgressDiv();
                }, 1000)

                if (res["emailSend"]) {
                    $('#userId').val(res["userId"]);
                    $('#emailddl').attr('disabled', true);
                    $('.spn-rotp').removeClass('d-none')
                    setLabelForResendOTP();
                }
                else {
                    $('#userId').val(res["userId"]);
                    alert("unable to send email now.")
                }
            })
        }

        const setLabelForResendOTP = () => {
            if (startTimerCount > -1) {
                $('.spn-rotp').text(startTimerCount)
                startTimerCount--;
                setTimeout(() => { setLabelForResendOTP() }, 1000)
            }
            else {
                $('.spn-rotp').addClass('d-none')
                $('.btn-submit').text('Resent OTP');
            }
        }

    </script>
}